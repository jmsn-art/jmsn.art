<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Make a Halo – jmsn.art</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png">

  <!-- Canonical -->
  <link rel="canonical" href="https://jmsn.art/make-halo.html">

  <!-- SEO -->
  <meta name="description" content="Upload an image and place a minimalist Art Circle halo. Auto-place with on-device face detection when supported. Download as PNG.">
  <meta name="author" content="Jameson McShane">

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FQPZNDPCGF"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments)}
    gtag('js', new Date());
    gtag('config', 'G-FQPZNDPCGF');
  </script>

  <style>
    :root{ --bg:#111; --fg:#fff; --muted:#9a9a9a; --panel:#181818; --line:#2a2a2a; }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family:Arial,Helvetica,sans-serif; line-height:1.35;
      display:flex; flex-direction:column;
    }
    header,footer{
      padding:14px 18px; opacity:.95;
      display:flex; align-items:center; justify-content:space-between;
    }
    header a, footer a{ color:var(--fg); text-decoration:underline }
    .wrap{ display:grid; grid-template-columns:1fr; gap:14px; padding:14px; }
    .stage{
      background:#0d0d0d; border:1px solid var(--line); border-radius:12px;
      display:flex; align-items:center; justify-content:center; min-height:50vh;
      position:relative; overflow:hidden;
    }
    canvas{ max-width:100%; height:auto; background:transparent; touch-action:none }
    .controls{
      background:var(--panel); border:1px solid var(--line); border-radius:12px;
      padding:12px; display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px;
    }
    .grp{ display:flex; flex-direction:column; gap:6px }
    .grp label{ font-size:.9rem; color:var(--muted) }
    .row{ display:flex; gap:8px; align-items:center }
    input[type="range"]{ width:100% }
    input[type="file"]{ display:block }
    button{
      background:#1b1b1b; color:#fff; border:1px solid var(--line);
      padding:10px 12px; border-radius:999px; cursor:pointer;
    }
    button:hover{ border-color:#777 }
    .inline{ display:flex; gap:10px; flex-wrap:wrap }
    .hint{ font-size:.85rem; color:var(--muted) }
    .badge{
      font-size:.8rem; padding:3px 8px; border-radius:999px; border:1px solid var(--line);
      background:#121212; color:#c0ffc0;
    }
    .warn{ color:#ffcc88 }
    @media (min-width: 980px){
      .wrap{ grid-template-columns:1fr 360px }
      .controls{ grid-template-columns:1fr }
    }
  </style>
</head>
<body>
  <header>
    <div>Make a Halo</div>
    <nav class="inline">
      <a href="/">Gallery</a>
      <a href="/make.html">Make an Art Circle</a>
      <a href="/about.html">About</a>
      <a href="/contact.html">Contact</a>
    </nav>
  </header>

  <main class="wrap">
    <section class="stage">
      <canvas id="c" width="1600" height="1600" aria-label="Halo editor canvas"></canvas>
    </section>

    <aside class="controls" aria-label="Halo controls">
      <div class="grp">
        <label for="file">Upload Image</label>
        <input id="file" type="file" accept="image/*">
        <div class="hint">Drag to move halo · Wheel/pinch to scale · ←/→ rotate</div>
      </div>

      <div class="grp">
        <label>Halo Controls</label>
        <div class="row"><input type="range" id="radius" min="60" max="800" value="260"><span class="hint">Radius</span></div>
        <div class="row"><input type="range" id="strokeW" min="2" max="60" value="10"><span class="hint">Stroke</span></div>
        <div class="row"><input type="range" id="gap" min="0" max="180" value="35"><span class="hint">Gap (°)</span></div>
        <div class="row"><input type="range" id="rot" min="0" max="359" value="0"><span class="hint">Rotate (°)</span></div>
      </div>

      <div class="grp">
        <label>Colors & Glow</label>
        <div class="row"><input type="color" id="stroke" value="#d4af37"><span class="hint">Halo color</span></div>
        <div class="row"><input type="color" id="shadow" value="#d4af37"><span class="hint">Glow color</span></div>
        <div class="row"><input type="range" id="glow" min="0" max="80" value="24"><span class="hint">Glow</span></div>
        <div class="row"><input type="color" id="bg" value="#111111"><span class="hint">Background (fills empty areas)</span></div>
      </div>

      <div class="grp">
        <label>Placement</label>
        <div class="inline">
          <button id="auto">Auto-place Halo</button>
          <span id="autoState" class="badge" hidden>FaceDetector on-device</span>
        </div>
        <div class="hint">Auto uses your browser’s FaceDetector (on-device). If unsupported, place manually.</div>
      </div>

      <div class="grp">
        <label>Export</label>
        <div class="inline">
          <button id="download">Download PNG (D)</button>
          <button id="reset">Reset</button>
        </div>
      </div>

      <div class="grp">
        <label>Status</label>
        <div class="hint" id="status">Load a photo to begin.</div>
      </div>
    </aside>
  </main>

  <footer>
    © 2025 Jameson McShane · <a href="/">jmsn.art</a>
  </footer>

  <script>
    // --- Elements
    const $ = id => document.getElementById(id);
    const cv = $('c');
    const cx = cv.getContext('2d');
    const el = {
      file:$('file'), radius:$('radius'), strokeW:$('strokeW'), gap:$('gap'),
      rot:$('rot'), stroke:$('stroke'), shadow:$('shadow'), glow:$('glow'),
      bg:$('bg'), auto:$('auto'), autoState:$('autoState'), download:$('download'),
      reset:$('reset'), status:$('status')
    };

    // --- State
    const state = {
      img:null, imgW:0, imgH:0, // image
      scale:1,                   // image fit scale
      halo:{ x:800, y:700, r: +el.radius.value, rot:+el.rot.value }, // position
      dragging:false, dragOffX:0, dragOffY:0
    };

    // --- Helpers
    function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }
    function radians(deg){ return (deg * Math.PI)/180; }

    // Fit the uploaded image into the canvas
    function draw() {
      // background fill
      cx.fillStyle = el.bg.value;
      cx.fillRect(0,0,cv.width,cv.height);

      if (state.img) {
        const cw = cv.width, ch = cv.height;
        const iw = state.imgW, ih = state.imgH;
        const s = Math.min(cw/iw, ch/ih);
        state.scale = s;
        const dx = (cw - iw*s)/2;
        const dy = (ch - ih*s)/2;
        cx.save();
        cx.imageSmoothingQuality = 'high';
        cx.drawImage(state.img, 0,0, iw,ih, dx,dy, iw*s, ih*s);
        cx.restore();
      }

      drawHalo();
    }

    function drawHalo(){
      const {x,y,r,rot} = state.halo;
      const strokeW = +el.strokeW.value;
      const gap = +el.gap.value;

      cx.save();
      cx.translate(x,y);
      cx.rotate(radians(rot));

      // Glow first
      cx.shadowColor = el.shadow.value;
      cx.shadowBlur  = +el.glow.value;

      cx.lineCap = 'round';
      cx.strokeStyle = el.stroke.value;
      cx.lineWidth = strokeW;

      // Halo arc with a gap centered at 0°
      const start = radians(gap/2);
      const end   = radians(360 - gap/2);

      cx.beginPath();
      cx.arc(0,0, r, start, end, false);
      cx.stroke();

      cx.restore();
    }

    // --- Upload handler
    el.file.addEventListener('change', e => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const img = new Image();
      img.onload = () => {
        state.img = img;
        state.imgW = img.naturalWidth;
        state.imgH = img.naturalHeight;

        // Default halo near top-center
        state.halo.x = cv.width/2;
        state.halo.y = cv.height/2 - 200;

        el.status.textContent = `Loaded ${f.name} (${state.imgW}×${state.imgH})`;
        draw();
      };
      img.src = URL.createObjectURL(f);
    });

    // --- Drag to move halo
    cv.addEventListener('pointerdown', (e) => {
      const rect = cv.getBoundingClientRect();
      const x = (e.clientX - rect.left) * (cv.width/rect.width);
      const y = (e.clientY - rect.top)  * (cv.height/rect.height);
      const dx = x - state.halo.x, dy = y - state.halo.y;
      const dist = Math.hypot(dx,dy);
      // start drag if near halo radius (tolerate +/- 40px)
      if (Math.abs(dist - state.halo.r) < 40 || dist < state.halo.r * 0.8) {
        state.dragging = true;
        state.dragOffX = dx; state.dragOffY = dy;
        cv.setPointerCapture(e.pointerId);
      }
    });
    cv.addEventListener('pointermove', (e) => {
      if (!state.dragging) return;
      const rect = cv.getBoundingClientRect();
      const x = (e.clientX - rect.left) * (cv.width/rect.width);
      const y = (e.clientY - rect.top)  * (cv.height/rect.height);
      state.halo.x = clamp(x - state.dragOffX, 0, cv.width);
      state.halo.y = clamp(y - state.dragOffY, 0, cv.height);
      draw();
    });
    cv.addEventListener('pointerup', (e) => {
      state.dragging = false;
      cv.releasePointerCapture(e.pointerId);
    });

    // --- Wheel / pinch to scale halo
    cv.addEventListener('wheel', (e) => {
      e.preventDefault();
      const delta = Math.sign(e.deltaY);
      state.halo.r = clamp(state.halo.r * (1 - 0.06*delta), 40, 800);
      el.radius.value = Math.round(state.halo.r);
      draw();
    }, {passive:false});

    // --- Controls
    ['radius','strokeW','gap','rot','stroke','shadow','glow','bg'].forEach(id=>{
      $(id).addEventListener('input', ()=>{
        if (id === 'radius') state.halo.r = +el.radius.value;
        if (id === 'rot')    state.halo.rot = +el.rot.value;
        draw();
      });
    });

    // --- Keyboard: arrows rotate, D download
    window.addEventListener('keydown', (e)=>{
      if (e.key === 'ArrowLeft')  { state.halo.rot = (state.halo.rot + 357) % 360; el.rot.value = state.halo.rot; draw(); }
      if (e.key === 'ArrowRight') { state.halo.rot = (state.halo.rot +   3) % 360; el.rot.value = state.halo.rot; draw(); }
      if (e.key === 'd' || e.key === 'D') downloadPNG();
    });

    // --- Auto place with FaceDetector (on-device if supported)
    async function autoPlace() {
      if (!('FaceDetector' in window)) {
        el.status.innerHTML = 'Auto-place not supported in this browser. <span class="warn">Place manually.</span>';
        return;
      }
      try {
        const det = new FaceDetector({ fastMode:true, maxDetectedFaces:1 });
        // Run on what’s drawn: make a bitmap from current canvas
        const bitmap = await createImageBitmap(cv);
        const faces = await det.detect(bitmap);
        if (!faces.length) {
          el.status.textContent = 'No face detected. Try manual placement.';
          return;
        }
        const f = faces[0].boundingBox; // {x,y,width,height}
        // Position halo slightly above the face center
        const cxFace = f.x + f.width/2;
        const cyFace = f.y + f.height/2;
        state.halo.x = cxFace;
        state.halo.y = cyFace - f.height*0.7; // above head
        state.halo.r = Math.max(f.width, f.height) * 0.6;
        el.radius.value = Math.round(state.halo.r);
        draw();
        el.status.textContent = 'Auto-placed halo using on-device face detection.';
      } catch (err) {
        console.error(err);
        el.status.textContent = 'Face detection error. Place manually.';
      }
    }

    // --- Export
    function downloadPNG(){
      const a = document.createElement('a');
      a.download = `halo-${Date.now()}.png`;
      a.href = cv.toDataURL('image/png');
      a.click();
    }

    function resetAll(){
      state.halo = { x:800, y:700, r:260, rot:0 };
      el.radius.value = 260; el.strokeW.value = 10; el.gap.value = 35; el.rot.value = 0;
      el.stroke.value = '#d4af37'; el.shadow.value = '#d4af37'; el.glow.value = 24; el.bg.value = '#111111';
      draw();
    }

    el.auto.addEventListener('click', autoPlace);
    el.download.addEventListener('click', downloadPNG);
    el.reset.addEventListener('click', resetAll);

    // Show whether FaceDetector is available
    if ('FaceDetector' in window) {
      el.autoState.hidden = false;
      el.autoState.textContent = 'On-device face detection available';
    } else {
      el.autoState.hidden = false;
      el.autoState.textContent = 'Auto-place not available';
      el.autoState.style.color = '#ffdf9a';
      el.autoState.style.borderColor = '#5a3';
    }

    // Initial paint
    draw();
  </script>
</body>
</html>
